<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Realtime Simulation</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    .info {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 8px 10px;
      border-radius: 6px;
      font-family: sans-serif;
      font-size: 14px;
      z-index: 9999;
      box-shadow: 0 1px 6px rgba(0,0,0,0.2);
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div class="info" id="info">Waiting for positions.json ...</div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // 1) Map
    const map = L.map('map').setView([51.2562, 7.1508], 12); // Wuppertal default

    // 2) (OpenStreetMap Tiles)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // 3) Marker-Container
    // Walker marker
    const walkerMarker = L.circleMarker([51.2562, 7.1508], { radius: 8 }).addTo(map);

    // Driver marker array
    const driverMarkers = [];

    //Status-UI
    const info = document.getElementById("info");

    function ensureDriverMarkers(n) {
      while (driverMarkers.length < n) {
        const idx = driverMarkers.length;
        const m = L.circleMarker([0,0], { radius: 5 }).addTo(map);
        m.bindTooltip("Driver " + idx);
        driverMarkers.push(m);
      }
    }

    // 4) positions.json
    async function updateFromPositions() {
      try {
        // cache-buster
        const res = await fetch('positions.json?ts=' + Date.now());
        const data = await res.json();

        // walker
        const w = data.walker; // {lat, lon}
        walkerMarker.setLatLng([w.lat, w.lon]);

        // drivers
        const drivers = data.drivers; // list of {lat, lon}
        ensureDriverMarkers(drivers.length);

        for (let i = 0; i < drivers.length; i++) {
          driverMarkers[i].setLatLng([drivers[i].lat, drivers[i].lon]);
        }

        // optional: map center on walker
        // map.panTo([w.lat, w.lon], { animate: false });

        info.textContent = "t = " + Math.round(data.t_s) + " s | drivers = " + drivers.length;
      } catch (err) {
        info.textContent = "Waiting for positions.json ...";
      }
    }

    // 5) Update Loop start
    // 200ms = 5 Hz (smooth)
    setInterval(updateFromPositions, 200);
  </script>
</body>
</html>
